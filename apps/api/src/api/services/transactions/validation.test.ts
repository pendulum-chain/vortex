import {describe, expect, it} from "bun:test";
import {Networks, PresignedTx} from "@packages/shared";
import {validatePresignedTxs} from "./validation";

// @ts-ignore
const VALID_EXAMPLE_PRESIGNED_TX_EUR_ONRAMP: PresignedTx[] = [
  {
    "nonce": 0,
    "phase": "moneriumOnrampSelfTransfer",
    "signer": "0x441D7df1551e3750AD2B5629A5DB2c316e7e0f89",
    "txData": "0x02f8d38189808522ef8a61de8522ef8a61de830186a09418ec0a6e18e5bc3784fdd3a3634b31245ab704f680b86423b872dd000000000000000000000000976ff31a56daf5a0e09f411950311f5877ff00d5000000000000000000000000441d7df1551e3750ad2b5629a5db2c316e7e0f89000000000000000000000000000000000000000000000000a688906bd8b00000c080a07724aeb861281600a776570db236f60ac3762afecb021c4291d11d16a9443849a021bf29fe0aeea6f4d2ad321f1f8ab53998a4779a2ebf3bc29c3e60287e3016b4",
    "network": Networks.Polygon,
    "meta": {}
  },
  {
    "nonce": 1,
    "phase": "squidRouterApprove",
    "signer": "0x441D7df1551e3750AD2B5629A5DB2c316e7e0f89",
    "txData": "0x02f8b38189018522ecb25c008522ef8a61de830249f09418ec0a6e18e5bc3784fdd3a3634b31245ab704f680b844095ea7b3000000000000000000000000ce16f69375520ab01377ce7b88f5ba8c48f8d666000000000000000000000000000000000000000000000000a688906bd8b00000c080a027303cbee431c59d8122dc70f4179bd82be7251ebbf7b057b22c671c0fc78721a04e0004c85b181f0af98935241910f675b44d4c3d0c2459393c37813120a49dab",
    "network": Networks.Polygon,
    "meta": {}
  },
  {
    "nonce": 2,
    "phase": "squidRouterSwap",
    "signer": "0x441D7df1551e3750AD2B5629A5DB2c316e7e0f89",
    "txData": "0x02f904eb8189028522ecb25c008522ef8a61de83058b8894ce16f69375520ab01377ce7b88f5ba8c48f8d666872386f26fc10000b9047458181a8000000000000000000000000018ec0a6e18e5bc3784fdd3a3634b31245ab704f6000000000000000000000000000000000000000000000000a688906bd8b0000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018ec0a6e18e5bc3784fdd3a3634b31245ab704f6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000044095ea7b300000000000000000000000068b3465833fb72a70ecdf485e0e4c7bd8665fc45ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000018ec0a6e18e5bc3784fdd3a3634b31245ab704f60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000068b3465833fb72a70ecdf485e0e4c7bd8665fc45000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000e404e45aaf00000000000000000000000018ec0a6e18e5bc3784fdd3a3634b31245ab704f60000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000976ff31a56daf5a0e09f411950311f5877ff00d5000000000000000000000000000000000000000000000000a688906bd8b000000000000000000000000000000000000000000000000000000000000000d3f913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000018ec0a6e18e5bc3784fdd3a3634b31245ab704f600000000000000000000000000000000000000000000000000000000000000044528e10e2137d5bf5d2940727fcc9007c080a0c699dbbd1d28d5fe95e013f950f6050adf99622fbaf71d5db6dace36646ee0eaa073e405accd62d5d7d7dbc535a69d10a140872b58715bcacae6e9187c8db24c7e",
    "network": Networks.Polygon,
    "meta": {}
  }
]

const INVALID_EXAMPLE_PRESIGNED_TX_BRL_ONRAMP: PresignedTx[] = [{
  "nonce": 0,
  "phase": "nablaApprove",
  "signer": "5FgbufBD6JxhRNNB8ZsLjCV6KYj8ckCDwvE7B7eyD7TqhQXR",
  "txData": "0x71038400a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb4301f62d176acb45a863ebae3709df421b2defb33fe72fc6147207993b1b9deee551bbcb588f4970f36071a240ce4228b1057f9ce007c60842b159386028098f2e850000000038060093dfde426795690be15b2071741d6538cd265eb673a9e9a1ae4e4389fda96a620007cdd55d7302ce800200001101095ea7b3e0a5f34199e165cbd3f9b0eba1f5e15d5018a7ffe8b76a3693ba5b317efb09d80000f3f19039f5eb0a0000000000000000000000000000000000000000000000",
  "network": Networks.Pendulum,
  "meta": {}
}, {
  "nonce": 1,
  "phase": "nablaSwap",
  "signer": "5FgbufBD6JxhRNNB8ZsLjCV6KYj8ckCDwvE7B7eyD7TqhQXR",
  "txData": "0x75058400a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb4301724b37f1e574c36c134413a1b4061bae052062fd7335cba8099c85085477f51fd26a52437c7354e2b112c77a1b6da82fc7e16b2cdefded23e29cf99382ba088d00040000380600e0a5f34199e165cbd3f9b0eba1f5e15d5018a7ffe8b76a3693ba5b317efb09d80007003a9a535082584f0000150338ed17390000f3f19039f5eb0a0000000000000000000000000000000000000000000000db131e02000000000000000000000000000000000000000000000000000000000893dfde426795690be15b2071741d6538cd265eb673a9e9a1ae4e4389fda96a6290573e0b663336bc844ddd1293af95b0b1872f2677f93e11cc658fafddc58db9a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb431539056900000000000000000000000000000000000000000000000000000000",
  "network": Networks.Pendulum,
  "meta": {}
}, {
  "nonce": 2,
  "phase": "distributeFees",
  "signer": "5FgbufBD6JxhRNNB8ZsLjCV6KYj8ckCDwvE7B7eyD7TqhQXR",
  "txData": "0xe9028400a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb4301bc4af4d401ae3733559df90c661296530e73bdf383f2972352c855b653126a22b80c10286b74e82c8a0fb3e2611147bce40681eae85fbf4ae59e1b95a6db448f00080000330208350200a2b2a8753c39705138998ee3285ab982e1d4f87ff90e626d46938b3e995e2cbd010c4a910300350200a2b2a8753c39705138998ee3285ab982e1d4f87ff90e626d46938b3e995e2cbd010cd139",
  "network": Networks.Pendulum,
  "meta": {}
}, {
  "nonce": 3,
  "phase": "pendulumToMoonbeamXcm",
  "signer": "5FgbufBD6JxhRNNB8ZsLjCV6KYj8ckCDwvE7B7eyD7TqhQXR",
  "txData": "0xbd028400a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb430106e0fca06b3aa0e994839220bad17f059f89c45073ff9a40ed01b7393e9b961d8104bc027c630f787ee0546c93339e296280655e3dfd45c3b2e16d725edc7788000c0000360408010c5c78390200000000000000000000000001060000c52ebca2b10000000000000000000100000003010200511f03001983259996e1908f24b56f426f08703c9db8028b00",
  "network": Networks.Pendulum,
  "meta": {}
}, {
  "nonce": 4,
  "phase": "pendulumCleanup",
  "signer": "5FgbufBD6JxhRNNB8ZsLjCV6KYj8ckCDwvE7B7eyD7TqhQXR",
  "txData": "0x69038400a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb4301da4322dfeaafdc5ccf2e0a74db0c0b5b3d7d354b8fd51d842764ea1067d849456b54d9adc4a08a468c86868ab3cd3935330dd8d69ad52442237d54fb3efe75810010000033020c35010056d9583bf0369fff4a35d997b2b5f5997843311823b1aa88fe9661874984e647010d0035010056d9583bf0369fff4a35d997b2b5f5997843311823b1aa88fe9661874984e647010c000a040056d9583bf0369fff4a35d997b2b5f5997843311823b1aa88fe9661874984e64700",
  "network": Networks.Pendulum,
  "meta": {}
}, {
  "nonce": 0,
  "phase": "moonbeamToPendulumXcm",
  "signer": "0x1983259996E1908f24b56f426F08703C9Db8028B",
  "txData": "0xd102841983259996e1908f24b56f426f08703c9db8028b05324d37b4ab9246b12aa8a7d2305301e483084bdbb57ffa20fd753f963600ff69515f73988e35ecfcf858399a3bba39b7dfaae39d6fe3c2ee27a3cc5b3539b70000000000670b03010100b9200300010100a01582bb42b04405d0a42133d3a055e85ebd12599d3519a764978b294a91cb430304000002046e0300feb25f3fddad13f82c4d6dbc1481516f6223642900170000f3f19039f5eb0a0000000000",
  "network": Networks.Moonbeam,
  "meta": {}
}, {
  "nonce": 4,
  "phase": "moonbeamCleanup",
  "signer": "0x1983259996E1908f24b56f426F08703C9Db8028B",
  "txData": "0xc501841983259996e1908f24b56f426f08703c9db8028b42b71f210447f6a4cbe2f27a83061a7344c7165b1a7ee9f6ab872d5824002f7f3e0ed12431e714f48c5256440004603d194feb9f5af3999434dccda0cfe8f18800001000000a04ec733ccc573cbb46211876149e1830c58c6133e200",
  "network": Networks.Moonbeam,
  "meta": {}
}, {
  "nonce": 2,
  "phase": "squidRouterApprove",
  "signer": "0x1983259996E1908f24b56f426F08703C9Db8028B",
  "txData": "0x02f8af8205040280852ba7def300830249f094ca01a1d0993565291051daff390892518acfad3a80b844095ea7b3000000000000000000000000ce16f69375520ab01377ce7b88f5ba8c48f8d666000000000000000000000000000000000000000000000000000000000239785cc001a03c97fa6de9e5628c19ade9b232e592ef53b4edad3b138686203f42221d0226b2a0700507c293767e967679aef05cf8b022194c4e9d56c74ce98385e9e328d3f939",
  "network": Networks.Moonbeam,
  "meta": {}
}, {
  "nonce": 3,
  "phase": "squidRouterSwap",
  "signer": "0x1983259996E1908f24b56f426F08703C9Db8028B",
  "txData": "0x02f907e78205040380852ba7def3008311652094ce16f69375520ab01377ce7b88f5ba8c48f8d666872386f26fc10000b907742147796000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000239785c0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000001983259996e1908f24b56f426f08703c9db8028b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000761786c55534443000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007506f6c79676f6e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a3078636531364636393337353532306162303133373763653742383866354241384334384638443636360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005700000000000000000000000000000000000000000000000000000000000000040000000000000000000000000aaa6087e4aaf0bd510562edca1a9acf69223e1a700000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000750e4c4984a9e0f12978ea6742bc1c5d248f40ed0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000750e4c4984a9e0f12978ea6742bc1c5d248f40ed000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000044095ea7b300000000000000000000000068b3465833fb72a70ecdf485e0e4c7bd8665fc45ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000750e4c4984a9e0f12978ea6742bc1c5d248f40ed0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000068b3465833fb72a70ecdf485e0e4c7bd8665fc45000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000e404e45aaf000000000000000000000000750e4c4984a9e0f12978ea6742bc1c5d248f40ed0000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c33590000000000000000000000000000000000000000000000000000000000000064000000000000000000000000aaa6087e4aaf0bd510562edca1a9acf69223e1a7000000000000000000000000000000000000000000000000000000000239785c0000000000000000000000000000000000000000000000000000000002389f910000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000750e4c4984a9e0f12978ea6742bc1c5d248f40ed0000000000000000000000000000000000000000000000000000000000000004d2c6d79e5486d7392340214a9f2595d100000000000000000000000000000000d2c6d79e5486d7392340214a9f2595d1c001a0723fdf0fbd4387112ff2cf1d6aa74de1e120d92fb037ff3e758da6ef403693b3a03faf1d0cc7526db50871a12ae2d5ff700c08a3ada12afcecf2fbaa7d73810f5a",
  "network": Networks.Moonbeam,
  "meta": {}
}]


describe("Presigned Transaction validation", () => {
  it("should pass validation for valid presigned EVM transactions", () => {
    expect(() => validatePresignedTxs(VALID_EXAMPLE_PRESIGNED_TX_EUR_ONRAMP)).not.toThrow();
  });

  it("should pass validation for single valid presigned transaction", () => {
    const singleTx: PresignedTx[] = [VALID_EXAMPLE_PRESIGNED_TX_EUR_ONRAMP[0]];
    expect(() => validatePresignedTxs(singleTx)).not.toThrow();
  })

  it("should throw for transaction with mismatch of expected signer for Substrate tx", () => {
    // Deep copy to avoid mutating the original
    const invalidTxs: PresignedTx[] = JSON.parse(JSON.stringify(INVALID_EXAMPLE_PRESIGNED_TX_BRL_ONRAMP))
    invalidTxs[0].signer = "5CoKLhtjijsxVneDXeV3QhcdD4byxDK7cSmNCuWEfQ8NjebM"
    expect(() => validatePresignedTxs(invalidTxs)).toThrow("Substrate transaction signer 14cu3zSGx6EAruNh6CvLsMKFBAinK3kN2QxbLQeKmCVMt3Se does not match the expected signer 5CoKLhtjijsxVneDXeV3QhcdD4byxDK7cSmNCuWEfQ8NjebM");
  }, 10000)

  it("should throw for transaction with mismatch of expected signer for EVM tx", () => {
    // Deep copy to avoid mutating the original
    const invalidTxs: PresignedTx[] = JSON.parse(JSON.stringify(INVALID_EXAMPLE_PRESIGNED_TX_BRL_ONRAMP))
    expect(() => validatePresignedTxs(invalidTxs)).toThrow("EVM transaction 'from' address 0x7eD252D89aeA59A3EE3a7Cbc408C143a5a736850 does not match the signer address 0x1983259996E1908f24b56f426F08703C9Db8028B");
  }, 10000)

  it("should throw error for invalid presigned transactions array", () => {
    const invalidTxs: any = "invalid data";
    expect(() => validatePresignedTxs(invalidTxs)).toThrow("presignedTxs must be an array with 1-100 elements");
  })

  it("should throw error for too many transactions", () => {
    const invalidTxs: PresignedTx[] = new Array(101).fill(VALID_EXAMPLE_PRESIGNED_TX_EUR_ONRAMP[0]);
    expect(() => validatePresignedTxs(invalidTxs)).toThrow("presignedTxs must be an array with 1-100 elements");
  })
});

